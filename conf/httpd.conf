# --- 서버 기본 설정 ---
ServerRoot "/usr/local/apache2"
Listen 80
User www-data
Group www-data
ServerName localhost
DocumentRoot "/usr/local/apache2/htdocs"
ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 common
LogLevel debug rewrite:trace8

# --- 필수 모듈 불러오기 (프록시 모듈 추가) ---
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule dir_module modules/mod_dir.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule cgi_module modules/mod_cgi.so
LoadModule alias_module modules/mod_alias.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so

# --- 기본 폴더 접근 권한 ---
<Directory />
    AllowOverride none
    Require all denied
</Directory>
<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# --- [유지] CGI 설정을 전역에 배치 ---
ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"
<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options +ExecCGI
    Require all granted
</Directory>

#==================== PHP 소스 코드 유출 취약점 설정 ====================

# --- 1. PHP가 실행되는 메인 사이트 (www.local) ---
<VirtualHost *:80>
    ServerName www.local

    # PHP-FPM 연동 설정
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://php:9000"
    </FilesMatch>

    # DocumentRoot 혼동을 위한 RewriteRule
    RewriteEngine On
    RewriteRule "^/html/(.*)$" "/$1.html"
</VirtualHost>

# --- 2. 정적 파일만 서비스하는 사이트 (static.local) ---
<VirtualHost *:80>
    ServerName static.local

    # 중요: 이 사이트에는 PHP 처리 규칙이 없습니다!
    # 하지만 공격을 위해 RewriteRule은 필요합니다.
    RewriteEngine On
    RewriteRule "^/html/(.*)$" "/$1.html"
</VirtualHost>

Alias /usr/share "/usr/share"

<Directory "/usr/share">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted

    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://php:9000"
    </FilesMatch>
</Directory>